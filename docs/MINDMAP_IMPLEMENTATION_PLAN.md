# CalmPlan Visual Command - Mind Map Layer
## תוכנית עבודה סופית לביצוע

---

## חלק א': סקירת האפיון והערות

### 1. קונספט - Single Source of Truth הויזואלי ✅ מאושר

**מה טוב:**
- המפה כ-View ולא כישות נפרדת - זה עיקרון ארכיטקטוני קריטי. כל שינוי במפה מעדכן DB ולהיפך
- ברירת מחדל Focus Mode - מונע הצפה קוגניטיבית
- ניווט היברידי (Double-click → Deep Link) - חוסך context switching

**הערות יישום:**
- המפה תהיה React component שמאזין ל-entities קיימים (Task, Client, etc.) דרך ה-base44 client
- לא צריך סכמת DB חדשה עבור צמתים - הם נגזרים מהדאטה הקיים
- נשתמש ב-`createPageUrl()` הקיים לניווט Deep Link

---

### 2. ארכיטקטורת Semantic Zoom ✅ מאושר

**3 רמות:**
| רמה | מה רואים | Zoom Level |
|------|----------|------------|
| מבט על | 5 ענפי-על + סטטוס כללי | < 0.5 |
| מבט עבודה | שירותים + אינדיקטורים כמותיים | 0.5 - 1.0 |
| מבט פרטני | לקוחות כ"עלים" + סטטוס אישי | > 1.0 |

**הערת יישום:**
- ReactFlow תומך ב-viewport events שמאפשרים לנו לשלוט מה מוצג בכל רמת זום
- נשתמש ב-`onMoveEnd` callback כדי לזהות zoom level ולהחליף תוכן צמתים
- Clustering (בועות) מעל 10 לקוחות בענף - פתרון מעולה

---

### 3. מנוע סטטוס ויזואלי (ADHD Friendly) ✅ מאושר

| אלמנט | מקור הנתונים | יישום |
|--------|-------------|-------|
| צבע (Halo) | `STATUS_CONFIG` הקיים | CSS box-shadow צבעוני |
| גודל (Weight) | ספירת משימות פתוחות per branch | `transform: scale()` דינמי |
| אנימציה (Pulse) | deadline ב-24 שעות | CSS `@keyframes pulse` |

**הערה:** כבר קיים `STATUS_CONFIG` עם צבעים (אדום/צהוב/ירוק) ב-`processTemplates.js` - נמפה ישירות

---

### 4. תפריט ימני (Quick-Action Engine) ✅ מאושר עם שינויים

**מה נבנה:**
1. שינוי סטטוס מהיר - ✅ ישיר מ-`STATUS_CONFIG`
2. שליחת תזכורת - ⏳ שלב 2 (דורש WhatsApp API)
3. צפייה במסמכים - ✅ Drawer עם `FileMetadata` entity
4. הגדר כחוזרת - ✅ מיני-טופס ל-`RecurringTasks` entity
5. העבר ל-Inbox - ✅ חדש
6. קישור לעמוד לקוח - ✅ `createPageUrl()`

**הערה:** נשתמש ב-Radix UI `ContextMenu` שכבר מותקן בפרויקט

---

### 5. פיצ'רים ייחודיים - סדרי עדיפויות

| פיצ'ר | שלב | סיבה |
|--------|------|-------|
| Inbox צף | שלב 1 | קריטי ל-ADHD workflow |
| Brain Dump | שלב 1 | יצירת משימות מהירה |
| Focus Mode ("מה עכשיו?") | שלב 1 | ברירת מחדל |
| "תצוגת רשימת היום" | שלב 1 | גשר בין מפה לביצוע |
| Calm Down + Pomodoro | שלב 2 | Nice to have |
| Cross-Linking | שלב 2 | מורכב ויזואלית |
| Context Memory ("איפה עצרתי?") | שלב 2 | דורש tracking חדש |
| Dopamine Progress | שלב 3 | אנימציות |

---

### 6. פתרון חולשות ✅ מאושר

- **100 לקוחות:** Clustering בועות - מובנה ב-ReactFlow
- **ביצוע יומי:** כפתור "רשימת היום" = פאנל צד ליניארי
- **Show on Map:** כפתור בכל עמוד קיים → ניווט למפה עם focus על הצומת

---

## חלק ב': מיפוי מלא של כל הלוחות והעמודים הקיימים

### מבנה המפה המלא - כל צומת (Node) וה-Deep Link שלו

```
🏢 CalmPlan (מרכז ראשי)
│
├── 📋 תפעול שוטף (ענף 1 - "מה עכשיו?")
│   │
│   ├── 🔴 דחופים
│   │   └── [צמתי לקוחות עם דדליין ב-48 שעות - דינמי]
│   │
│   ├── 🟡 בטיפול
│   │   └── [צמתי משימות בסטטוס in_progress - דינמי]
│   │
│   ├── 👁️ פוקוס יומי → /Home
│   │   └── [משימות היום, אירועים, מעקב תשלומים]
│   │
│   ├── ✅ כל המשימות → /Tasks
│   │   └── [סינון לפי קטגוריה, סטטוס, לקוח]
│   │
│   ├── 📊 מטריצת עדיפויות → /TaskMatrix
│   │   └── [משימות לפי דחיפות × מורכבות]
│   │
│   └── 📅 לוח שנה → /Calendar
│       └── [תצוגות יום/שבוע/חודש]
│
├── 💰 חשבות שכר (ענף 2 - "המכונה")
│   │
│   ├── 📊 לוח שכר ראשי → /PayrollDashboard
│   │   │
│   │   ├── 💵 שכר (payroll)
│   │   │   └── [לקוח₁ → קבלת נתונים → הכנת תלושים → הגהה → קליטת פקודה → רישום תשלומים → רישום רשויות]
│   │   │
│   │   ├── 🏛️ ביטוח לאומי (social_security)
│   │   │   └── [לקוח₁ → הכנת דו"ח → דיווח]
│   │   │
│   │   ├── 📑 ניכויים (deductions)
│   │   │   └── [לקוח₁ → הכנת דו"ח → דיווח]
│   │   │
│   │   ├── 💳 מס"ב עובדים (masav_employees)
│   │   │   └── [לקוח₁ → הכנת קובץ → העלאה → אישור]
│   │   │
│   │   ├── 💳 מס"ב סוציאליות (masav_social)
│   │   │   └── [לקוח₁ → הכנת קובץ → העלאה → אישור]
│   │   │
│   │   ├── 💳 מס"ב רשויות (masav_authorities)
│   │   │   └── [לקוח₁ → הכנת קובץ → העלאה → אישור]
│   │   │
│   │   ├── 💳 מס"ב ספקים (masav_suppliers)
│   │   │   └── [לקוח₁ → הכנת קובץ → העלאה → אישור]
│   │   │
│   │   ├── 📬 משלוח תלושים (payslip_sending)
│   │   │   └── [לקוח₁ → הפקה → שליחה]
│   │   │
│   │   ├── 🏛️ תשלום רשויות (authorities_payment)
│   │   │   └── [לקוח₁ → הכנת דו"ח → תשלום]
│   │   │
│   │   ├── ⚔️ תביעות מילואים (reserve_claims)
│   │   │   └── [לקוח₁ → הכנת תביעה → הגשה → מעקב]
│   │   │
│   │   └── 📋 הנחיות מס"ב ממתפעל (social_benefits)
│   │       └── [לקוח₁ → קבלת הנחיות → ביצוע]
│   │
│   └── 📈 דיווחים מרכזים תקופתיים → /PeriodicSummaryReports
│       └── [סיכומי חודש מרוכזים]
│
├── 🧾 הנה"ח ומיסים (ענף 3 - "דיווחי חובה")
│   │
│   ├── 📊 דיווחי מיסים חודשיים → /TaxReportsDashboard
│   │   │
│   │   ├── 📝 מע"מ (vat)
│   │   │   └── [לקוח₁ → קליטת הכנסות → קליטת הוצאות → הכנת דו"ח → דיווח]
│   │   │
│   │   ├── 💰 מקדמות מס הכנסה (tax_advances)
│   │   │   └── [לקוח₁ → חישוב → דיווח ותשלום]
│   │   │
│   │   └── 📄 מע"מ 874 (vat_874)
│   │       └── [לקוח₁ → הפקת נתונים → הכנת דו"ח → שידור]
│   │
│   ├── 🔄 התאמות חשבונות → /Reconciliations
│   │   └── [לקוח₁ → קבלת דפי בנק → ביצוע התאמה → טיפול בהפרשים]
│   │
│   ├── 📊 מאזנים שנתיים → /BalanceSheets
│   │   └── [לקוח₁ → איסוף חומרים → הכנת דו"ח → עיון → הגשה]
│   │
│   ├── 📚 הנהלת חשבונות (bookkeeping)
│   │   └── [לקוח₁ → קליטת הכנסות → קליטת הוצאות → התאמות]
│   │
│   └── 💼 ייעוץ (consulting)
│       └── [לקוח₁ → ביצוע ייעוץ → סיכום ותיעוד]
│
├── ➕ שירותים נוספים (ענף 4)
│   │
│   ├── 📊 לוח שירותים נוספים → /AdditionalServicesDashboard
│   │   │
│   │   ├── 📋 דיווח למתפעל (operator_reporting)
│   │   │   └── [לקוח₁ → הכנת דו"ח → שליחה]
│   │   │
│   │   └── 📋 דיווח לטמל (taml_reporting)
│   │       └── [לקוח₁ → הכנת דו"ח → שליחה]
│   │
│   └── 📊 ריכוז דיווחים חודשיים → /ClientsDashboard
│       └── [תצוגה מרוכזת של כל הלקוחות וכל השירותים]
│
├── 📝 אדמיניסטרציה (ענף 5 - "המשרד")
│   │
│   ├── 📊 לוח אדמיניסטרטיבי → /AdminTasksDashboard
│   │   │
│   │   ├── 📋 אדמיניסטרציה כללית (admin)
│   │   │   └── [משימה₁ → ביצוע]
│   │   │
│   │   ├── 📞 לחזור ללקוח (client_callback)
│   │   │   └── [לקוח₁ → ביצוע שיחה]
│   │   │
│   │   ├── 📣 מעקב שיווק (marketing_followup)
│   │   │   └── [ליד₁ → יצירת קשר → מעקב]
│   │   │
│   │   ├── 🤝 פגישות (meeting)
│   │   │   └── [לקוח₁ → תיאום → ביצוע]
│   │   │
│   │   └── 📌 כללי (general)
│   │       └── [משימות ללא קטגוריה]
│   │
│   ├── 📁 ניהול קבצים → /ClientFiles
│   │   └── [קבצים לפי לקוח]
│   │
│   └── 🏢 מרכז עסקי → /BusinessHub
│       └── [סקירה עסקית כללית]
│
├── 👥 לקוחות וצמיחה (ענף 6 - "האנשים")
│   │
│   ├── 👥 מרכז לקוחות → /ClientManagement
│   │   └── [כרטיס לקוח מלא, רשימה/גריד]
│   │
│   ├── 🎯 לידים → /Leads
│   │   └── [פייפליין מכירות]
│   │
│   ├── 📝 קליטת לקוח חדש → /ClientOnboarding
│   │   └── [טופס קליטה מלא]
│   │
│   ├── 💰 שכ"ט → /FeeManagement
│   │   └── [מעקב גביה ותשלומים]
│   │
│   ├── 📦 אוספים/קבוצות → /Collections
│   │   └── [קיבוץ לקוחות לקבוצות]
│   │
│   └── 📂 ספקים ונותני שירות → /ServiceProviders
│       └── [ניהול ספקים]
│
├── 📅 תכנון וניהול זמן (ענף 7 - "הסדר")
│   │
│   ├── 🧠 תכנון שבועי → /WeeklyPlanningDashboard
│   │   └── [סקירה שבועית אסטרטגית]
│   │
│   ├── 📊 סיכום שבועי → /WeeklySummary
│   │   └── [רטרוספקטיבה + תובנות]
│   │
│   ├── 🔁 משימות חוזרות → /RecurringTasks
│   │   └── [הגדרת תדירויות]
│   │
│   ├── ⚡ אוטומציות → /AutomationRules
│   │   └── [כללי אוטומציה]
│   │
│   ├── 📊 מעקב פרויקטים → /Projects
│   │   └── [פרויקטים עם ציר זמן]
│   │
│   ├── 🗺️ מפת דרכים → /Roadmap
│   │   └── [תכנון אסטרטגי]
│   │
│   └── 📈 אנליטיקס → /Analytics
│       └── [תובנות ודיווחים]
│
├── 📥 Inbox (ענף 8 - "החנייה" - צף תמיד)
│   └── [פריטים שנזרקו מכל מקום - טרם מוינו]
│
└── 🏠 LENA - בית וחיים (ענף 9 - אופציונלי)
    ├── 🍽️ תכנון ארוחות → /MealPlanner
    ├── 📚 השראה → /Inspiration
    └── ⚙️ הגדרות אישיות → /LifeSettings
```

### עמודי מערכת (לא חלק מהמפה - נגישים רק מהתפריט)
- `/Settings` - הגדרת פרמטרים
- `/DataImportTool` - ייבוא נתונים
- `/TestDataManager` - ניהול נתוני בדיקה
- `/EmergencyRecovery` - שחזור חירום
- `/EmergencyReset` - איפוס מערכת
- `/SystemOverview` - סקירת מערכת
- `/FullSync` - סנכרון מלא
- `/MondayIntegration` - שילוב Monday.com

---

## חלק ג': מורכבות קוגניטיבית ו-Time Blindness (T-Shirt Sizing)

### הבעיה
ADHD גורם ל"עיוורון זמן" - משימה של 5 דקות ומשימה של 5 שעות נראות אותו דבר ברשימה.
התוצאה: שיתוק החלטות. משימה גדולה = הר בלתי עביר. משימה קטנה = "רק 5 דקות" שדוחים.

### הפתרון: מידות T-Shirt למורכבות לקוח-שירות

| מידה | הגדרה | זמן משוער | ייצוג ויזואלי במפה |
|------|--------|-----------|-------------------|
| **S** | "חטף" | עד 10 דק' | עיגול קטן (scale: 0.7) |
| **M** | עבודה סטנדרטית | 30-60 דק' | עיגול רגיל (scale: 1.0) |
| **L** | Deep Work | שעתיים+ | עיגול גדול (scale: 1.4) + מסגרת מודגשת |
| **XL** | מפלצת | פיצול ימים | עיגול ענק (scale: 1.8) + מסגרת כפולה + אייקון ⚡ |

#### שדה חדש ב-DB: `complexity_score`
```javascript
// מתווסף ל-Task entity או כשדה ב-Client per service
{
  clientId: "123",
  service: "payroll",          // מפתח מ-ALL_SERVICES
  complexity: "L",             // S | M | L | XL
  estimatedMinutes: 120,       // הערכה בדקות
  mentalLoad: "high",          // low | medium | high (מעמיס מנטלית?)
  lastMentalLoadFeedback: null // פידבק מהביצוע הקודם
}
```

### פיצ'ר: "מה מתאים לי עכשיו?" (Energy Matching)

כפתור ב-Toolbar של המפה עם 3 מצבים:

| מצב | מה מוצג | מה מוסתר |
|-----|---------|----------|
| 🔋 אנרגיה נמוכה | רק S (חטיפים) | M, L, XL מעומעמים |
| ⚡ אנרגיה רגילה | S + M | L, XL מעומעמים |
| 🧠 Deep Work | לקוח L/XL **אחד בלבד** | כל השאר מוסתרים ("סוסים עם כיסויי עיניים") |

**הערך:** ב"אנרגיה נמוכה" אוספים Quick Wins (מעלים דופמין). ב-Deep Work מתמקדים בדבר אחד.

### פירוק אוטומטי של L/XL (Deconstruction)

לקוח שמוגדר L או XL לא מופיע כצומת אחד - הוא הופך ל"צומת מתרחב":

```
[לקוח XL: חברת ABC] ← לחיצה
    │
    ├── 📥 קליטת חומר (15 דק')      [✅]
    ├── 🔍 בדיקת התאמות (60 דק')    [🔄 בעבודה]
    ├── 📊 הפקה (60 דק')             [ ]
    └── ✅ בקרה (30 דק')              [ ]
```

**הערך:** המוח לא רואה "מפלצת של 5 שעות" אלא 4 משימות קטנות וניתנות לעיכול.

### "מדד שחיקה" (Mental Load Indicator)

אייקון 🧠 ליד לקוחות שמוגדרים כ-`mentalLoad: "high"` (נודניקים, מורכבים רגשית).
- המערכת מונעת תזמון של 3+ לקוחות "כבדים מנטלית" באותו יום
- אזהרה ויזואלית: "3 לקוחות עם עומס מנטלי גבוה היום - בטוח?"

### תפריט ימני חכם: "כמה זמן יש לי?"

לחיצה ימנית על ענף ראשי (למשל "שכר") → אפשרויות:

| בחירה | תוצאה |
|-------|--------|
| "יש לי 15 דקות" | מציג רק לקוחות S בענף |
| "יש לי שעה" | מציג S + M |
| "נכנס ל-Deep Work" | מציג לקוח L/XL אחד + Calm Down mode |

---

## חלק ג.2: תהליכי קליטה דינמיים ועבודה במנות (Batches)

### הבעיה
שלבי תהליך כמו "קליטת הוצאות" לא מתנהגים אותו דבר עבור כל הלקוחות:
- **לקוח קטן:** קליטה אחת בחודש, 5 דקות, סגור
- **לקוח גדול:** 3-4 סבבי קליטה בחודש, השלמות לפני מע"מ
- **לקוח OCR:** רק לוודא שנתקבלו חומרים, לפענח, לקלוט, לסגור

### פתרון 1: מד-צבירה (Accumulation Gauge)

במקום checkbox (בוצע/לא), צומת "קליטת הוצאות" מציג סוללה של 4 שלבים:

```
┌───────────────────────────┐
│ 📥 קליטת הוצאות - אברהם  │
│                           │
│ [████████░░░░░░░░] 50%    │
│                           │
│ ✅ חומר ב-OCR             │
│ ✅ פוענח                   │
│ ○  נקלט                   │
│ ○  סגור                   │
└───────────────────────────┘
```

**התנהגות לפי סוג לקוח:**
- **לקוח קטן:** הסוללה מתמלאת בבת אחת (פעם בחודש)
- **לקוח גדול:** הסוללה עומדת על 50% לאורך החודש, מגיעה ל-100% לקראת מע"מ
- **הערך:** מונע חרדה של "שכחתי לקלוט" - פשוט רואים כמה "טעון" כל לקוח

### פתרון 2: הבחנה בין "בקרה" ל"ביצוע" (Check vs. Do)

שני סוגי צמתים שונים:

| סוג | ייצוג ויזואלי | התנהגות |
|-----|--------------|---------|
| **ביצוע** (Do) | עיגול מלא + מד צבירה | דורש עבודה אקטיבית |
| **בקרה** (Check) | עיגול חלול מהבהב | רק צריך לוודא ולשחרר |

**לקוח "בקרה" (OCR):** עיגול חלול. כשמגיע חומר חדש ב-OCR → מתחיל להבהב.
לחיצה אחת על "בוצע" = מאפס הבהוב עד חומר הבא.
**הערך:** העבודה הופכת ל"כיבוי אורות" - לא מחפשים עבודה, רק מגיבים לאורות.

### פתרון 3: תצוגת "סבבים" ללקוחות גדולים (Staging View)

לחיצה על ענף "קליטת הוצאות" של לקוח גדול → תת-מפה:

```
קליטת הוצאות - חברת מגה
│
├── סבב א' (תחילת חודש)  [✅ נקלט]
├── סבב ב' (אמצע חודש)   [✅ נקלט]
├── סבב ג' (השלמות מע"מ)  [○ ממתין]
└── סגירה לדיווח           [🔒 נעול עד שכולם ✅]
```

**הערך:** ADHD גורם להרגשה ש"לא עשית כלום" כשהמשימה הכללית ("מע"מ") עדיין פתוחה.
כאן רואים: סיימת 2 סבבים בהצלחה! נותר רק 1.

### פתרון 4: תפריט ימני ייעודי לתהליכי קליטה

לחיצה ימנית על לקוח בענף "הוצאות":

1. **"פתח OCR"** → קישור ישיר לעמוד הלקוח במערכת OCR
2. **"סמן כנקלט חלקית"** → צבע כתום-מקווקו (= "עצרתי באמצע")
3. **"הקפץ דרישת חומר"** → שליחת הודעה אוטומטית: "העלית 5 חשבוניות, חסר חומר של דלק"
4. **"נקי לסגירה"** → סוגר כל תתי-המשימות → מעביר לענף "מוכן לדיווח מע"מ"

### פתרון 5: Pulse אוטומטי מ-OCR

| מצב | ייצוג ויזואלי | משמעות |
|-----|--------------|--------|
| אין חומר 10+ ימים | צומת שקוף | "אין כאן עבודה, אל תבזבז קשב" |
| חומר חדש הגיע | צומת "נדלק" (solid + הבהוב) | "יש עבודה, כנס ל-2 דקות" |
| נקלט חלקית | כתום מקווקו | "עצרת באמצע, תחזור" |
| הושלם | ירוק מלא | "סיימת, הלאה!" |

### סיכום: מצבי לקוח במפה (כל הצבעים)

| צבע | משמעות |
|-----|--------|
| 🟢 ירוק | סיימת קליטה |
| 🔵 מהבהב | חומר חדש ב-OCR, כנס ל-2 דקות |
| 🟠 כתום מקווקו | התחלת קליטה ועצרת באמצע |
| ⚪ שקוף | אין חומר, תתעלם |
| 🔴 אדום | דדליין עובר! |

---

## חלק ד': מפרט טכני

### ספריות נדרשות

```bash
npm install @xyflow/react
# ReactFlow v12 (חדש, מבוסס @xyflow/react)
# כבר יש בפרויקט: framer-motion, lucide-react, radix-ui
```

### מבנה קבצים

```
src/
├── pages/
│   └── MindMap.jsx                          # עמוד המפה הראשי
│
├── components/
│   └── mindmap/
│       ├── MindMapCanvas.jsx                # ReactFlow canvas wrapper
│       ├── MindMapToolbar.jsx               # סרגל כלים (Focus/Normal/Firefighting/Energy)
│       ├── MindMapInbox.jsx                 # פאנל Inbox צף
│       ├── MindMapDayList.jsx               # פאנל "רשימת היום" צד
│       ├── MindMapBrainDump.jsx             # מצב Brain Dump
│       ├── MindMapEnergySelector.jsx        # בורר "מה מתאים לי עכשיו?" (S/M/L/XL)
│       │
│       ├── nodes/                           # Custom Node Types
│       │   ├── CenterNode.jsx              # הצומת המרכזי "CalmPlan"
│       │   ├── BranchNode.jsx              # ענף ראשי (שכר, מיסים, לקוחות...)
│       │   ├── ServiceNode.jsx             # צומת שירות (מע"מ, שכר, ניכויים...)
│       │   ├── ClientNode.jsx              # צומת לקוח (עלה) - גודל דינמי לפי T-Shirt
│       │   ├── ClientExpandedNode.jsx      # צומת לקוח L/XL מורחב (תת-שלבים)
│       │   ├── DashboardNode.jsx           # צומת לוח מחוונים (deep link)
│       │   ├── TaskNode.jsx                # צומת משימה בודדת
│       │   ├── ClusterNode.jsx             # בועת קיבוץ (10+ לקוחות)
│       │   ├── InboxItemNode.jsx           # פריט ב-Inbox
│       │   ├── AccumulationNode.jsx        # צומת מד-צבירה (קליטת הוצאות)
│       │   ├── CheckpointNode.jsx          # צומת בקרה (עיגול חלול - OCR)
│       │   └── StagingNode.jsx             # צומת סבבים (לקוח גדול - batches)
│       │
│       ├── edges/
│       │   └── StatusEdge.jsx              # קשת עם צבע סטטוס
│       │
│       └── hooks/
│           ├── useMindMapData.js           # מושך Tasks, Clients → יוצר nodes/edges
│           ├── useSemanticZoom.js           # מנהל zoom levels
│           ├── useFocusMode.js             # סינון "מה עכשיו?"
│           ├── useNodeContextMenu.js       # תפריט ימני (כולל context-aware לקליטה)
│           ├── useInbox.js                 # ניהול Inbox state
│           ├── useEnergyFilter.js          # סינון לפי מפלס אנרגיה (T-Shirt)
│           └── useComplexityScoring.js     # חישוב מורכבות לקוח-שירות
│
├── config/
│   ├── mindmapLayout.js                    # הגדרות פריסה, צבעים, מיקומים ראשוניים
│   └── complexityConfig.js                 # הגדרות T-Shirt sizes + energy levels
│
└── utils/
    └── mindmapHelpers.js                   # פונקציות עזר (חישוב סטטוס, בניית עץ)
```

### Data Flow

```
[localStorage/Supabase]
       │
       ▼
[base44 Client] ─── Task.list(), Client.list(), etc.
       │
       ▼
[useMindMapData hook]
       │
       ├── מיפוי Tasks → ServiceNodes + ClientNodes
       ├── מיפוי Clients → ClientNodes
       ├── חישוב סטטוסים → צבעים + גדלים
       └── בניית edges (קשרים)
       │
       ▼
[ReactFlow Canvas]
       │
       ├── Custom Nodes (render)
       ├── Semantic Zoom (filter by zoom level)
       ├── Context Menu (quick actions)
       └── Focus Mode (filter by date)
```

### Custom Node Types

#### CenterNode (מרכז)
```
┌─────────────────────┐
│    🧠 CalmPlan      │
│  ──────────────────  │
│  12 דחוף │ 34 בעבודה│
│  סה"כ: 89 משימות    │
└─────────────────────┘
```

#### BranchNode (ענף ראשי)
```
┌──────────────────┐
│  💰 חשבות שכר    │
│  ═══════════════ │
│  ████████░░ 78%  │  ← מד התקדמות כללי
│  3🔴  5🟡  12🟢  │  ← ספירת סטטוסים
└──────────────────┘
```

#### ServiceNode (שירות)
```
┌─────────────────┐
│  📝 מע"מ        │
│  ──────────────  │
│  8/12 לקוחות ✅  │
│  ████████░░ 67% │
│  2 דדליינים ⚠️   │
└─────────────────┘
```

#### ClientNode (לקוח - עלה) - גודל דינמי לפי T-Shirt
```
 [S] קטן                [M] רגיל              [L] גדול                [XL] מפלצת
┌─────────┐         ┌─────────────┐       ┌──────────────────┐    ┌──────────────────────┐
│○ דני    │         │ ○ אברהם כהן │       │ ○ חברת אלפא ⚡    │    │ ○ חברת מגה ⚡⚡ 🧠     │
│ 5 דק'   │         │ שלב: דיווח  │       │ שלב: בדיקת התאמ' │    │ Deep Work נדרש       │
│          │         │ ████░░ 60%  │       │ ████████░░ 80%   │    │ ████░░░░░░░░ 33%     │
└─────────┘         └─────────────┘       │ ~2 שעות          │    │ ~5 שעות (4 שלבים)   │
 scale: 0.7          scale: 1.0           └──────────────────┘    └──────────────────────┘
                                            scale: 1.4              scale: 1.8
```

#### ClientExpandedNode (L/XL - תת-שלבים)
```
┌─────────────────────────────┐
│ ⚡ חברת מגה [XL]             │
│ ════════════════════════════ │
│ ✅ קליטת חומר (15 דק')       │
│ 🔄 בדיקת התאמות (60 דק')    │
│ ○  הפקה (60 דק')             │
│ ○  בקרה (30 דק')             │
│ ════════════════════════════ │
│ ████████░░░░ 50%             │
└─────────────────────────────┘
```

#### AccumulationNode (מד-צבירה - קליטת הוצאות)
```
┌───────────────────────────┐
│ 📥 קליטת הוצאות - אברהם  │
│                           │
│ [████████░░░░░░░░] 50%    │
│                           │
│ ✅ חומר ב-OCR             │
│ ✅ פוענח                   │
│ ○  נקלט                   │
│ ○  סגור                   │
└───────────────────────────┘
```

#### CheckpointNode (בקרה - OCR)
```
    ╭ ─ ─ ─ ─ ─ ─╮
    ╎  ◌ דני כהן  ╎   ← עיגול חלול (בקרה בלבד)
    ╎  OCR ✓      ╎   ← מהבהב כשיש חומר חדש
    ╰ ─ ─ ─ ─ ─ ─╯
```

#### StagingNode (סבבים - לקוח גדול)
```
┌──────────────────────────┐
│ 📦 קליטה - חברת מגה      │
│ ═════════════════════════ │
│ ✅ סבב א' (תחילת חודש)   │
│ ✅ סבב ב' (אמצע חודש)    │
│ ○  סבב ג' (השלמות)       │
│ 🔒 סגירה לדיווח          │
│ ═════════════════════════ │
│ 2/3 סבבים הושלמו         │
└──────────────────────────┘
```

#### ClusterNode (בועת קיבוץ)
```
    ┌───────┐
    │  23   │  ← מספר לקוחות
    │ לקוח  │
    └───────┘
    (לחיצה מפזרת)
```

---

## חלק ה': שלבי יישום

### שלב 1: שלד המפה + T-Shirt Sizing (Sprint 1 - ~25 שעות עבודה)

#### 1.1 תשתית בסיסית
- [ ] התקנת `@xyflow/react`
- [ ] יצירת עמוד `MindMap.jsx` + הוספה ל-routes
- [ ] הוספת "מפת פיקוד" לתפריט הניווט (Layout.jsx)
- [ ] יצירת `MindMapCanvas.jsx` עם ReactFlow בסיסי
- [ ] יצירת `complexityConfig.js` עם הגדרות T-Shirt (S/M/L/XL)

#### 1.2 Custom Nodes בסיסיים
- [ ] `CenterNode` - הצומת המרכזי
- [ ] `BranchNode` - 9 ענפים ראשיים (ראה מבנה מעלה)
- [ ] `DashboardNode` - צמתים עם Deep Link לכל 30+ עמודים קיימים
- [ ] `ServiceNode` - צמתי שירותים (מ-processTemplates.js)
- [ ] `ClientNode` - עם גודל דינמי לפי complexity (S/M/L/XL)

#### 1.3 Data Hook בסיסי
- [ ] `useMindMapData.js` - מושך Tasks + Clients ובונה nodes/edges
- [ ] מיפוי `ALL_SERVICES` מ-processTemplates → ServiceNodes
- [ ] מיפוי navigationGroups מ-Layout → DashboardNodes
- [ ] חישוב סטטוס צבעוני per node
- [ ] `useComplexityScoring.js` - חישוב T-Shirt size per client-service

#### 1.4 Toolbar + מצבי תצוגה
- [ ] `MindMapToolbar.jsx` עם 4 כפתורים: רגיל / Focus / Firefighting / Energy
- [ ] Focus Mode: מסנן לפי deadline = היום/שבוע
- [ ] Firefighting: מציג רק אדומים (status = issue / overdue)
- [ ] `MindMapEnergySelector.jsx` - "מה מתאים לי עכשיו?" (אנרגיה נמוכה/רגילה/Deep Work)

**תוצר:** מפה סטטית עם כל הענפים, צבעי סטטוס, deep links, T-Shirt sizes, ו-Energy Matching

---

### שלב 2: אינטראקטיביות + מורכבות (Sprint 2 - ~25 שעות)

#### 2.1 Semantic Zoom
- [ ] `useSemanticZoom.js` - מזהה zoom level ומסנן nodes
- [ ] Zoom Out: רק ענפים ראשיים
- [ ] Mid Zoom: ענפים + שירותים + אינדיקטורים
- [ ] Zoom In: לקוחות כעלים (גודל לפי T-Shirt)

#### 2.2 Context Menu (תפריט ימני)
- [ ] `useNodeContextMenu.js` - Radix ContextMenu
- [ ] שינוי סטטוס מהיר (dropdown)
- [ ] "פתח כרטיס מלא" (Deep Link)
- [ ] "הגדר כחוזרת" (מיני-טופס → RecurringTasks)
- [ ] "העבר ל-Inbox"
- [ ] "צפה במסמכים" (Drawer + FileMetadata)
- [ ] **"כמה זמן יש לי?"** - סינון לפי 15 דק' / שעה / Deep Work (על ענף ראשי)

#### 2.3 ClientNode מתקדם + T-Shirt
- [ ] `ClientNode.jsx` עם הילת סטטוס (halo)
- [ ] **גודל דינמי**: S=0.7x, M=1.0x, L=1.4x, XL=1.8x
- [ ] Pulse animation לדדליינים קרובים
- [ ] **אייקון 🧠** ללקוחות עם `mentalLoad: "high"`
- [ ] `ClientExpandedNode.jsx` - צומת מתרחב ל-L/XL עם תת-שלבים

#### 2.4 Clustering
- [ ] `ClusterNode.jsx` - בועה עם ספירה
- [ ] לחיצה על בועה = מפזרת לקוחות סביבה
- [ ] אוטומטי כשיש 10+ לקוחות בענף

#### 2.5 Energy Filter
- [ ] `useEnergyFilter.js` - סינון לפי מפלס אנרגיה
- [ ] אנרגיה נמוכה: רק S מוצג, שאר מעומעמים
- [ ] אנרגיה רגילה: S + M מוצגים
- [ ] Deep Work: לקוח L/XL אחד בלבד + Calm Down אוטומטי
- [ ] **אזהרת שחיקה**: "3 לקוחות כבדים מנטלית היום - בטוח?"

**תוצר:** מפה אינטראקטיבית עם zoom, context menu, T-Shirt sizing, Energy Matching

---

### שלב 3: Inbox + Brain Dump + תהליכי קליטה (Sprint 3 - ~25 שעות)

#### 3.1 Inbox צף
- [ ] `MindMapInbox.jsx` - פאנל צד שתמיד פתוח
- [ ] קיצור מקלדת (Ctrl+I) לזריקת פריט
- [ ] גרירת פריט מ-Inbox לענף במפה → יצירת Task
- [ ] בסוף יום: "יש 3 פריטים ב-Inbox, לאן לשבץ?"

#### 3.2 Brain Dump
- [ ] `MindMapBrainDump.jsx` - מצב הקלדה מהירה
- [ ] Enter אחרי כל שורה = צומת זמני צף
- [ ] גרירת צמתים זמניים לענפים → יצירת Tasks

#### 3.3 רשימת היום
- [ ] `MindMapDayList.jsx` - פאנל צד ליניארי
- [ ] כפתור "רשימת היום" → מציג כל הצמתים האדומים/צהובים כרשימה
- [ ] **מיון לפי T-Shirt**: חטיפים (S) למעלה, כבדים (L/XL) למטה
- [ ] Checkbox לסימון השלמה (מעדכן DB)

#### 3.4 תהליכי קליטה דינמיים (Batch Work)
- [ ] `AccumulationNode.jsx` - צומת מד-צבירה (סוללה 4 שלבים)
- [ ] `CheckpointNode.jsx` - צומת בקרה (OCR) - עיגול חלול מהבהב
- [ ] `StagingNode.jsx` - תצוגת סבבים ללקוחות גדולים
- [ ] **הבחנה "ביצוע" vs "בקרה"**: סוג צומת שונה per client type
- [ ] **תפריט ימני ייעודי לקליטה**: פתח OCR / סמן כנקלט חלקית / דרישת חומר / נקי לסגירה
- [ ] **Pulse אוטומטי**: שקוף (אין חומר) → מהבהב (חומר חדש) → כתום (חלקי) → ירוק (סגור)

#### 3.5 Show on Map
- [ ] הוספת כפתור "הצג במפה" בכל עמוד קיים
- [ ] לחיצה → ניווט ל-/MindMap עם query param → center + zoom על הצומת

**תוצר:** מפה עם Inbox, Brain Dump, רשימת יום, תהליכי קליטה חכמים, ניווט דו-כיווני

---

### שלב 4: שיפורים ופיצ'רים מתקדמים (Sprint 4 - ~20 שעות)

#### 4.1 Calm Down Mode
- [ ] כפתור "Calm Down" → מסתיר הכל חוץ מענף נוכחי
- [ ] טיימר Pomodoro מובנה (25 דקות)
- [ ] צליל/ויברציה בסיום

#### 4.2 Cross-Linking
- [ ] זיהוי לקוחות שמופיעים ביותר משירות אחד
- [ ] בכניסה לצומת לקוח: "גם פתוח אצלו: מע"מ, שכר"
- [ ] כפתור מעבר מהיר בין שירותים של אותו לקוח

#### 4.3 Context Memory
- [ ] שמירת "פעולה אחרונה" per client per service
- [ ] פתק דביק מיני בכניסה לצומת: "עצרת ב: הכנת דו"ח מע"מ (לפני 3 ימים)"
- [ ] שמירה ב-localStorage

#### 4.4 Dopamine Progress
- [ ] ענף "בוצע היום" שגדל
- [ ] אנימציית "עף לענף" בהשלמת משימה
- [ ] סטטיסטיקות יומיות (כמה הושלם)

#### 4.5 פידבק מורכבות (Self-Learning)
- [ ] אחרי השלמת משימה: "איך הרגשת?" (קל/ממוצע/מעמיס)
- [ ] עדכון אוטומטי של `mentalLoad` לפי פידבק
- [ ] שיפור הערכות T-Shirt לאורך זמן

---

## חלק ו': אינטגרציה עם מערכת קיימת

### entities שנקראים (קריאה בלבד)
| Entity | שימוש במפה |
|--------|-----------|
| `Task` | צמתי משימות, סטטוסים, דדליינים, process_steps |
| `Client` | צמתי לקוחות, שמות, קטגוריות, שירותים |
| `Event` | אירועים בלוח שנה |
| `Lead` | צמתים בענף "לידים" |
| `FileMetadata` | תצוגת קבצים ב-context menu |
| `Invoice` | מעקב תשלומים בצומת לקוח |

### entities שנכתבים (עדכון)
| Entity | פעולה מהמפה |
|--------|------------|
| `Task` | שינוי סטטוס, יצירת משימה חדשה (Brain Dump), עדכון process_steps |
| `Task` (חדש) | שדות: `complexity` (S/M/L/XL), `mental_load`, `batch_round` |
| `StickyNote` | יצירת פתק מ-Inbox |
| `RecurringTasks` | הגדרת משימה חוזרת מ-context menu |
| `Client` (הרחבה) | שדה `service_complexity` per service (T-Shirt), `mental_load_score` |

### config שנקרא
| Config | שימוש |
|--------|-------|
| `processTemplates.js` | `ALL_SERVICES` → ServiceNodes + שלבי תהליך + Accumulation steps |
| `processTemplates.js` | `STATUS_CONFIG` → צבעי הילה |
| `Layout.jsx` | `navigationGroups` → מבנה ענפים + deep links |
| `complexityConfig.js` (חדש) | T-Shirt definitions, Energy levels, Mental load thresholds |

### שדות DB חדשים (schema extensions)

#### Client entity - שדות חדשים:
```javascript
{
  // ... שדות קיימים ...
  service_complexity: {
    payroll: { size: "L", estimatedMinutes: 120, mentalLoad: "high" },
    vat: { size: "M", estimatedMinutes: 45, mentalLoad: "low" },
    // ... per service
  },
  client_type: "do" | "check",    // ביצוע או בקרה (OCR)
  ocr_integration: true | false,   // האם מחובר ל-OCR
}
```

#### Task entity - שדות חדשים:
```javascript
{
  // ... שדות קיימים ...
  complexity: "S" | "M" | "L" | "XL",  // מורכבות (מחושב/ידני)
  mental_load_feedback: null,            // פידבק מהביצוע: "easy" | "medium" | "heavy"
  batch_round: null,                     // מספר סבב (1, 2, 3...) ללקוחות גדולים
  batch_total: null,                     // סה"כ סבבים צפויים
  intake_status: null,                   // "ocr_received" | "decoded" | "entered" | "closed"
  last_action_context: null,             // "איפה עצרתי?" - טקסט חופשי
}
```

---

## חלק ז': סיכום לביצוע

### סדר עדיפויות מוחלט

| # | משימה | שלב | תלות | חדש? |
|---|--------|------|-------|------|
| 1 | התקנת @xyflow/react | 1.1 | - | |
| 2 | MindMap page + route | 1.1 | #1 | |
| 3 | complexityConfig.js (T-Shirt sizes) | 1.1 | - | **חדש** |
| 4 | CenterNode + BranchNodes | 1.2 | #2 | |
| 5 | useMindMapData hook | 1.3 | #4 | |
| 6 | DashboardNodes (deep links ל-30+ עמודים) | 1.2 | #5 | |
| 7 | ServiceNodes מ-processTemplates | 1.2 | #5 | |
| 8 | ClientNode עם T-Shirt sizing (גודל דינמי) | 1.2 | #5, #3 | **חדש** |
| 9 | useComplexityScoring hook | 1.3 | #3 | **חדש** |
| 10 | סטטוסים צבעוניים (halo) | 1.3 | #7 | |
| 11 | Toolbar + Focus/Firefighting/Energy | 1.4 | #10 | **מורחב** |
| 12 | MindMapEnergySelector ("מה מתאים לי?") | 1.4 | #9 | **חדש** |
| 13 | Semantic Zoom | 2.1 | #11 | |
| 14 | Context Menu (כולל "כמה זמן יש לי?") | 2.2 | #13 | **מורחב** |
| 15 | ClientExpandedNode (L/XL תת-שלבים) | 2.3 | #8 | **חדש** |
| 16 | useEnergyFilter hook | 2.5 | #9, #12 | **חדש** |
| 17 | אזהרת שחיקה (3+ כבדים ביום) | 2.5 | #16 | **חדש** |
| 18 | ClientNodes + Clustering | 2.3-2.4 | #13 | |
| 19 | Inbox צף | 3.1 | #14 | |
| 20 | Brain Dump | 3.2 | #19 | |
| 21 | רשימת היום (מיון T-Shirt) | 3.3 | #14, #9 | **מורחב** |
| 22 | AccumulationNode (מד-צבירה) | 3.4 | #7 | **חדש** |
| 23 | CheckpointNode (בקרה OCR) | 3.4 | #7 | **חדש** |
| 24 | StagingNode (סבבים) | 3.4 | #22 | **חדש** |
| 25 | תפריט ימני ייעודי לקליטה | 3.4 | #14, #22 | **חדש** |
| 26 | Pulse אוטומטי (שקוף/מהבהב/כתום/ירוק) | 3.4 | #23 | **חדש** |
| 27 | Show on Map (כפתור בכל עמוד) | 3.5 | #13 | |
| 28 | Calm Down + Pomodoro | 4.1 | #14 | |
| 29 | Cross-Linking | 4.2 | #18 | |
| 30 | Context Memory ("איפה עצרתי?") | 4.3 | #18 | |
| 31 | Dopamine Progress | 4.4 | #21 | |
| 32 | פידבק מורכבות (Self-Learning) | 4.5 | #8, #9 | **חדש** |

### קריטריונים להצלחה

1. **שלב 1 מוכן:** מפה נפתחת עם כל הענפים, צבעי סטטוס, deep links לכל עמוד, T-Shirt sizing, ו-Energy Matching בסיסי
2. **שלב 2 מוכן:** Semantic zoom, תפריט ימני + "כמה זמן יש לי?", L/XL expansion, Energy Filter + אזהרת שחיקה
3. **שלב 3 מוכן:** Inbox + Brain Dump + רשימת יום + תהליכי קליטה (מד-צבירה, בקרה OCR, סבבים)
4. **שלב 4 מוכן:** Calm Down, Cross-Links, Memory, Dopamine, Self-Learning

### סיכום כמותי

| מדד | ערך |
|-----|-----|
| סה"כ קבצים חדשים | ~25 |
| סה"כ קבצים מעודכנים (קיימים) | ~5 (Layout, index, processTemplates...) |
| ספריות חדשות | 1 (@xyflow/react) |
| Custom Node Types | 12 |
| Custom Hooks | 7 |
| עמודים קיימים שמקבלים "Show on Map" | 30+ |
| שלבי יישום | 4 sprints |
| שעות עבודה משוערות | ~95 שעות |
